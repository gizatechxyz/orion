use core::traits::Into;
use orion::numbers::{FP64x64, FixedTrait};
use cubit::f128::ONE_u128 as ONE;

const ERF_COMPUTATIONAL_ACCURACY: u128 = 100_u128; 
const ROUND_CHECK_NUMBER: u128 = 10_u128;
// Values > MAX_ERF_NUMBER return 1
const MAX_ERF_NUMBER: u128 = 64563604257983430656_u128;
// Values <= ERF_TRUNCATION_NUMBER -> two decimal places, and values > ERF_TRUNCATION_NUMBER -> one decimal place
const ERF_TRUNCATION_NUMBER: u128 = 36893488147419103232_u128;

fn get_lookup_table_values(x: u128) -> u128{
	// Construct the erf lookup table
	if x <= 1660206966633859584 { 		
		if x <= 0 { 
			return 0; 
		}
		if x <= 184467440737095520 { 
			return 208142279036071072; 
		}
		if x <= 368934881474191040 { 
			return 416242934472567232; 
		}
		if x <= 553402322211286528 { 
			return 624260367679495296; 
		}
		if x <= 737869762948382080 { 
			return 832153029941062528; 
		}
		if x <= 922337203685477632 { 
			return 1039879447350402944; 
		}
		if x <= 1106804644422573056 { 
			return 1247398245629553408; 
		}
		if x <= 1291272085159668736 { 
			return 1454668174849927424; 
		}
		if x <= 1475739525896764160 { 
			return 1661648134028665088; 
		}
		if x <= 1660206966633859584 { 
			return 1868297195576427008; 
		}
	}
	if x <= 3504881374004814848 { 		
		if x <= 1844674407370955264 { 
			return 2074574629572391936; 
		}
		if x <= 2029141848108050688 { 
			return 2280439927842463744; 
		}
		if x <= 2213609288845146112 { 
			return 2485852827816977408; 
		}
		if x <= 2398076729582241792 { 
			return 2690773336144481280; 
		}
		if x <= 2582544170319337472 { 
			return 2895161752038532608; 
		}
		if x <= 2767011611056432640 { 
			return 3098978690334796800; 
		}
		if x <= 2951479051793528320 { 
			return 3302185104236156928; 
		}
		if x <= 3135946492530624000 { 
			return 3504742307723958272; 
		}
		if x <= 3320413933267719168 { 
			return 3706611997613982720; 
		}
		if x <= 3504881374004814848 { 
			return 3907756275236240384; 
		}
	}
	if x <= 5349555781375769600 { 		
		if x <= 3689348814741910528 { 
			return 4108137667718166528; 
		}
		if x <= 3873816255479005696 { 
			return 4307719148851377152; 
		}
		if x <= 4058283696216101376 { 
			return 4506464159522699776; 
		}
		if x <= 4242751136953197056 { 
			return 4704336627690769408; 
		}
		if x <= 4427218577690292224 { 
			return 4901300987890141184; 
		}
		if x <= 4611686018427387904 { 
			return 5097322200245477376; 
		}
		if x <= 4796153459164483584 { 
			return 5292365768979031040; 
		}
		if x <= 4980620899901579264 { 
			return 5486397760395360256; 
		}
		if x <= 5165088340638674944 { 
			return 5679384820327877632; 
		}
		if x <= 5349555781375769600 { 
			return 5871294191032579072; 
		}
	}
	if x <= 7194230188746725376 { 		
		if x <= 5534023222112865280 { 
			return 6062093727515032576; 
		}
		if x <= 5718490662849960960 { 
			return 6251751913277435904; 
		}
		if x <= 5902958103587056640 { 
			return 6440237875473368064; 
		}
		if x <= 6087425544324152320 { 
			return 6627521399458594816; 
		}
		if x <= 6271892985061248000 { 
			return 6813572942727099392; 
		}
		if x <= 6456360425798342656 { 
			return 6998363648222307328; 
		}
		if x <= 6640827866535438336 { 
			return 7181865357014296576; 
		}
		if x <= 6825295307272534016 { 
			return 7364050620334585856; 
		}
		if x <= 7009762748009629696 { 
			return 7544892710960923648; 
		}
		if x <= 7194230188746725376 { 
			return 7724365633945352192; 
		}
	}
	if x <= 9038904596117680128 { 		
		if x <= 7378697629483821056 { 
			return 7902444136679609344; 
		}
		if x <= 7563165070220915712 { 
			return 8079103718292817920; 
		}
		if x <= 7747632510958011392 { 
			return 8254320638377208832; 
		}
		if x <= 7932099951695107072 { 
			return 8428071925038478336; 
		}
		if x <= 8116567392432202752 { 
			return 8600335382268215296; 
		}
		if x <= 8301034833169298432 { 
			return 8771089596636659712; 
		}
		if x <= 8485502273906394112 { 
			return 8940313943304876032; 
		}
		if x <= 8669969714643488768 { 
			return 9107988591356256256; 
		}
		if x <= 8854437155380584448 { 
			return 9274094508448081920; 
		}
		if x <= 9038904596117680128 { 
			return 9438613464784658432; 
		}
	}
	if x <= 10883579003488634880 { 		
		if x <= 9223372036854775808 { 
			return 9601528036414361600; 
		}
		if x <= 9407839477591871488 { 
			return 9762821607853701120; 
		}
		if x <= 9592306918328967168 { 
			return 9922478374042292224; 
		}
		if x <= 9776774359066062848 { 
			return 10080483341633368064; 
		}
		if x <= 9961241799803158528 { 
			return 10236822329625237504; 
		}
		if x <= 10145709240540254208 { 
			return 10391481969339820032; 
		}
		if x <= 10330176681277349888 { 
			return 10544449703755059200; 
		}
		if x <= 10514644122014443520 { 
			return 10695713786198818816; 
		}
		if x <= 10699111562751539200 { 
			return 10845263278412423168; 
		}
		if x <= 10883579003488634880 { 
			return 10993088047992748032; 
		}
	}
	if x <= 12728253410859589632 { 		
		if x <= 11068046444225730560 { 
			return 11139178765222393856; 
		}
		if x <= 11252513884962826240 { 
			return 11283526899298078720; 
		}
		if x <= 11436981325699921920 { 
			return 11426124713968005120; 
		}
		if x <= 11621448766437017600 { 
			return 11566965262589513728; 
		}
		if x <= 11805916207174113280 { 
			return 11706042382618923008; 
		}
		if x <= 11990383647911208960 { 
			return 11843350689545969664; 
		}
		if x <= 12174851088648304640 { 
			return 11978885570285762560; 
		}
		if x <= 12359318529385400320 { 
			return 12112643176041672704; 
		}
		if x <= 12543785970122496000 { 
			return 12244620414653018112; 
		}
		if x <= 12728253410859589632 { 
			return 12374814942441867264; 
		}
	}
	if x <= 14572927818230546432 { 		
		if x <= 12912720851596685312 { 
			return 12503225155573657600; 
		}
		if x <= 13097188292333780992 { 
			return 12629850180946728960; 
		}
		if x <= 13281655733070876672 { 
			return 12754689866626244608; 
		}
		if x <= 13466123173807972352 { 
			return 12877744771838261248; 
		}
		if x <= 13650590614545068032 { 
			return 12999016156540069888; 
		}
		if x <= 13835058055282163712 { 
			return 13118505970583140352; 
		}
		if x <= 14019525496019259392 { 
			return 13236216842485327872; 
		}
		if x <= 14203992936756355072 { 
			return 13352152067829151744; 
		}
		if x <= 14388460377493450752 { 
			return 13466315597303212032; 
		}
		if x <= 14572927818230546432 { 
			return 13578712024403965952; 
		}
	}
	if x <= 16417602225601501184 { 		
		if x <= 14757395258967642112 { 
			return 13689346572815177728; 
		}
		if x <= 14941862699704737792 { 
			return 13798225083482576896; 
		}
		if x <= 15126330140441831424 { 
			return 13905354001401262080; 
		}
		if x <= 15310797581178927104 { 
			return 14010740362133477376; 
		}
		if x <= 15495265021916022784 { 
			return 14114391778074478592; 
		}
		if x <= 15679732462653118464 { 
			return 14216316424484128768; 
		}
		if x <= 15864199903390214144 { 
			return 14316523025301962752; 
		}
		if x <= 16048667344127309824 { 
			return 14415020838763323392; 
		}
		if x <= 16233134784864405504 { 
			return 14511819642834194432; 
		}
		if x <= 16417602225601501184 { 
			return 14606929720482222080; 
		}
	}
	if x <= 18262276632972455936 { 		
		if x <= 16602069666338596864 { 
			return 14700361844801351680; 
		}
		if x <= 16786537107075692544 { 
			return 14792127264007346176; 
		}
		if x <= 16971004547812788224 { 
			return 14882237686321330176; 
		}
		if x <= 17155471988549883904 { 
			return 14970705264758325248; 
		}
		if x <= 17339939429286977536 { 
			return 15057542581837537280; 
		}
		if x <= 17524406870024073216 { 
			return 15142762634230988800; 
		}
		if x <= 17708874310761168896 { 
			return 15226378817366812672; 
		}
		if x <= 17893341751498264576 { 
			return 15308404910003300352; 
		}
		if x <= 18077809192235360256 { 
			return 15388855058789533696; 
		}
		if x <= 18262276632972455936 { 
			return 15467743762828154880; 
		}
	}
	if x <= 20106951040343412736 { 		
		if x <= 18446744073709551616 { 
			return 15545085858255493120; 
		}
		if x <= 18631211514446647296 { 
			return 15620896502854008832; 
		}
		if x <= 18815678955183742976 { 
			return 15695191160711634944; 
		}
		if x <= 19000146395920838656 { 
			return 15767985586942304256; 
		}
		if x <= 19184613836657934336 { 
			return 15839295812481531904; 
		}
		if x <= 19369081277395030016 { 
			return 15909138128970633216; 
		}
		if x <= 19553548718132125696 { 
			return 15977529073742716928; 
		}
		if x <= 19738016158869221376 { 
			return 16044485414923208704; 
		}
		if x <= 19922483599606317056 { 
			return 16110024136657332224; 
		}
		if x <= 20106951040343412736 { 
			return 16174162424476436480; 
		}
	}
	if x <= 21951625447714365440 { 		
		if x <= 20291418481080508416 { 
			return 16236917650814795776; 
		}
		if x <= 20475885921817604096 { 
			return 16298307360687947776; 
		}
		if x <= 20660353362554699776 { 
			return 16358349257543309312; 
		}
		if x <= 20844820803291791360 { 
			return 16417061189293291520; 
		}
		if x <= 21029288244028887040 { 
			return 16474461134540791808; 
		}
		if x <= 21213755684765982720 { 
			return 16530567189006364672; 
		}
		if x <= 21398223125503078400 { 
			return 16585397552166088704; 
		}
		if x <= 21582690566240174080 { 
			return 16638970514108524544; 
		}
		if x <= 21767158006977269760 { 
			return 16691304442618875904; 
		}
		if x <= 21951625447714365440 { 
			return 16742417770497863680; 
		}
	}
	if x <= 23796299855085322240 { 		
		if x <= 22136092888451461120 { 
			return 16792328983122491392; 
		}
		if x <= 22320560329188556800 { 
			return 16841056606255333376; 
		}
		if x <= 22505027769925652480 { 
			return 16888619194108602368; 
		}
		if x <= 22689495210662748160 { 
			return 16935035317668771840; 
		}
		if x <= 22873962651399843840 { 
			return 16980323553287045120; 
		}
		if x <= 23058430092136939520 { 
			return 17024502471540604928; 
		}
		if x <= 23242897532874035200 { 
			return 17067590626369081344; 
		}
		if x <= 23427364973611130880 { 
			return 17109606544490213376; 
		}
		if x <= 23611832414348226560 { 
			return 17150568715098355712; 
		}
		if x <= 23796299855085322240 { 
			return 17190495579848931328; 
		}
	}
	if x <= 25640974262456274944 { 		
		if x <= 23980767295822417920 { 
			return 17229405523131617280; 
		}
		if x <= 24165234736559513600 { 
			return 17267316862634573824; 
		}
		if x <= 24349702177296609280 { 
			return 17304247840201650176; 
		}
		if x <= 24534169618033704960 { 
			return 17340216612984107008; 
		}
		if x <= 24718637058770800640 { 
			return 17375241244887996416; 
		}
		if x <= 24903104499507896320 { 
			return 17409339698317971456; 
		}
		if x <= 25087571940244992000 { 
			return 17442529826217906176; 
		}
		if x <= 25272039380982087680 { 
			return 17474829364408369152; 
		}
		if x <= 25456506821719179264 { 
			return 17506255924220641280; 
		}
		if x <= 25640974262456274944 { 
			return 17536826985426591744; 
		}
	}
	if x <= 27485648669827231744 { 		
		if x <= 25825441703193370624 { 
			return 17566559889463431168; 
		}
		if x <= 26009909143930466304 { 
			return 17595471832952045568; 
		}
		if x <= 26194376584667561984 { 
			return 17623579861507229696; 
		}
		if x <= 26378844025404657664 { 
			return 17650900863837954048; 
		}
		if x <= 26563311466141753344 { 
			return 17677451566135410688; 
		}
		if x <= 26747778906878849024 { 
			return 17703248526746337280; 
		}
		if x <= 26932246347615944704 { 
			return 17728308131128877056; 
		}
		if x <= 27116713788353040384 { 
			return 17752646587087935488; 
		}
		if x <= 27301181229090136064 { 
			return 17776279920286781440; 
		}
		if x <= 27485648669827231744 { 
			return 17799223970031376384; 
		}
	}
	if x <= 29330323077198188544 { 		
		if x <= 27670116110564327424 { 
			return 17821494385323737088; 
		}
		if x <= 27854583551301423104 { 
			return 17843106621180358656; 
		}
		if x <= 28039050992038518784 { 
			return 17864075935211624448; 
		}
		if x <= 28223518432775614464 { 
			return 17884417384457840640; 
		}
		if x <= 28407985873512710144 { 
			return 17904145822477408256; 
		}
		if x <= 28592453314249805824 { 
			return 17923275896682506240; 
		}
		if x <= 28776920754986901504 { 
			return 17941822045917437952; 
		}
		if x <= 28961388195723997184 { 
			return 17959798498274711552; 
		}
		if x <= 29145855636461092864 { 
			return 17977219269143760896; 
		}
		if x <= 29330323077198188544 { 
			return 17994098159487121408; 
		}
	}
	if x <= 31174997484569141248 { 		
		if x <= 29514790517935284224 { 
			return 18010448754338713600; 
		}
		if x <= 29699257958672379904 { 
			return 18026284421518878720; 
		}
		if x <= 29883725399409475584 { 
			return 18041618310560610304; 
		}
		if x <= 30068192840146567168 { 
			return 18056463351841458176; 
		}
		if x <= 30252660280883662848 { 
			return 18070832255915431936; 
		}
		if x <= 30437127721620758528 { 
			return 18084737513039206400; 
		}
		if x <= 30621595162357854208 { 
			return 18098191392886906880; 
		}
		if x <= 30806062603094949888 { 
			return 18111205944447655936; 
		}
		if x <= 30990530043832045568 { 
			return 18123792996100098048; 
		}
		if x <= 31174997484569141248 { 
			return 18135964155858038784; 
		}
	}
	if x <= 33019671891940098048 { 		
		if x <= 31359464925306236928 { 
			return 18147730811781371904; 
		}
		if x <= 31543932366043332608 { 
			return 18159104132546453504; 
		}
		if x <= 31728399806780428288 { 
			return 18170095068170047488; 
		}
		if x <= 31912867247517523968 { 
			return 18180714350881038336; 
		}
		if x <= 32097334688254619648 { 
			return 18190972496134107136; 
		}
		if x <= 32281802128991715328 { 
			return 18200879803759552512; 
		}
		if x <= 32466269569728811008 { 
			return 18210446359243550720; 
		}
		if x <= 32650737010465906688 { 
			return 18219682035133120512; 
		}
		if x <= 32835204451203002368 { 
			return 18228596492560154624; 
		}
		if x <= 33019671891940098048 { 
			return 18237199182878894080; 
		}
	}
	if x <= 34864346299311050752 { 		
		if x <= 33204139332677193728 { 
			return 18245499349411323904; 
		}
		if x <= 33388606773414289408 { 
			return 18253506029294995456; 
		}
		if x <= 33573074214151385088 { 
			return 18261228055427880960; 
		}
		if x <= 33757541654888480768 { 
			return 18268674058504921088; 
		}
		if x <= 33942009095625576448 { 
			return 18275852469141008384; 
		}
		if x <= 34126476536362672128 { 
			return 18282771520075268096; 
		}
		if x <= 34310943977099767808 { 
			return 18289439248451522560; 
		}
		if x <= 34495411417836863488 { 
			return 18295863498169980928; 
		}
		if x <= 34679878858573955072 { 
			return 18302051922305267712; 
		}
		if x <= 34864346299311050752 { 
			return 18308011985585967104; 
		}
	}
	if x <= 36709020706682007552 { 		
		if x <= 35048813740048146432 { 
			return 18313750966931048448; 
		}
		if x <= 35233281180785242112 { 
			return 18319275962038544384; 
		}
		if x <= 35417748621522337792 { 
			return 18324593886022047744; 
		}
		if x <= 35602216062259433472 { 
			return 18329711476090615808; 
		}
		if x <= 35786683502996529152 { 
			return 18334635294267887616; 
		}
		if x <= 35971150943733624832 { 
			return 18339371730146226176; 
		}
		if x <= 36155618384470720512 { 
			return 18343927003671875584; 
		}
		if x <= 36340085825207816192 { 
			return 18348307167957243904; 
		}
		if x <= 36524553265944911872 { 
			return 18352518112116494336; 
		}
		if x <= 36709020706682007552 { 
			return 18356565564120772608; 
		}
	}
	if x <= 62718929850612473856 { 		
		if x <= 36893488147419103232 { 
			return 18360455093669533696; 
		}
		if x <= 38738162554790060032 { 
			return 18391782614824026112; 
		}
		if x <= 40582836962161016832 { 
			return 18412380624802023424; 
		}
		if x <= 42427511369531965440 { 
			return 18425656187587059712; 
		}
		if x <= 44272185776902922240 { 
			return 18434043234066948096; 
		}
		if x <= 46116860184273879040 { 
			return 18439237133993463808; 
		}
		if x <= 47961534591644835840 { 
			return 18442390007235248128; 
		}
		if x <= 49806208999015792640 { 
			return 18444266072035147776; 
		}
		if x <= 51650883406386741248 { 
			return 18445360324505407488; 
		}
		if x <= 53495557813757698048 { 
			return 18445985951670278144; 
		}
		if x <= 55340232221128654848 { 
			return 18446336575964956672; 
		}
		if x <= 57184906628499611648 { 
			return 18446529193908295680; 
		}
		if x <= 59029581035870568448 { 
			return 18446632918035736576; 
		}
		if x <= 60874255443241517056 { 
			return 18446687668919484416; 
		}
		if x <= 62718929850612473856 { 
			return 18446715997887504384; 
		}
	}
	return ONE;
}

fn erf(x: FP64x64) -> FP64x64{
    // Lookup
    // 1. if x.mag < 3.5 { lookup table }
    // 2. else{ return 1}
    let mut erf_value: u128 = 0_u128;

    if x.mag <= MAX_ERF_NUMBER {
        erf_value = get_lookup_table_values(x.mag);
    } else {
        erf_value = ONE;
    }
    FP64x64 { mag: erf_value, sign: x.sign }
}